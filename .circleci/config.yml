version: 2.1           

orbs: 
    slack: circleci/slack@4.10.1
    commands:
        notify_on_failure:
            steps:
            - slack/notify:
                event: fail
                channel: cicd-pipeline
                template: basic_fail_1
        notify_on_success:
            steps:
            - slack/notify:
                event: pass
                channel: cicd-pipeline
                template: success_tagged_deployment_1
jobs:
  build-frontend:
      docker:
        - image: circleci/node:13.8.0
      steps:
            - checkout
            - restore_cache:
                keys: [frontend-deps]
            - run:
                name: Build front-end
                command: |
                cd frontend
                npm install
                npm run build
                
            - save_cache:
                paths: [frontend/node_modules]
                key: frontend-deps
            - notify_on_failure

  build-backend:
      docker:
          - image: circleci/node:13.8.0
      steps:
            - checkout
            - restore_cache:
                keys: [backend-deps]
            - run:
                name: Back-end build
                command: |
                    cd backend
                    npm install
                    npm run build
                    
            - save_cache:
                    paths: [backend/node_modules]
                    key: backend-deps
            - notify_on_failure

  test-frontend:
      docker:
          - image: circleci/node:13.8.0
      steps:
            - checkout
            - restore_cache:
                keys: [frontend-deps]
            - run:
                name:  Front-end test
                command: |
                    cd frontend
                    npm install
                    npm run test
            - notify_on_failure
                

  test-backend:
      docker:
          - image: circleci/node:13.8.0
      steps:
            - checkout
            - restore_cache:
                keys: [backend-deps]
            - run:
                name: Back-end test
                command: |
                    cd backend
                    npm install
                    npm run test
            - notify_on_failure

  scan-frontend:
        docker:
            - image: circleci/node:13.8.0
        steps:
            - checkout
            - restore_cache:
                keys: [frontend-deps]
            - run:
                name:  Analyze frontend 
                command: |
                  cd frontend
                  npm install
                  npm audit fix --force --audit-level=critical
                  npm audit --audit-level=critical   
            - notify_on_failure

  scan-backend:
          docker:
              - image: circleci/node:13.8.0
          steps:
                - checkout
                - restore_cache:
                    keys: [backend-deps]
                - run:
                    name:  Analyze backend 
                    command: |
                        cd backend
                        npm install
                        npm audit fix --force --audit-level=critical
                        npm audit fix --force --audit-level=critical
                        npm audit --audit-level=critical   
                - notify_on_failure




workflows:
  default:
    jobs:
      - build-frontend
      - build-backend
      
      - test-frontend:
          requires: [build-frontend]
      - test-backend:
          requires: [build-backend]
      - scan-frontend:
          requires: [build-frontend]
      - scan-backend:
          requires: [build-backend]
     - notify_on_success:
            requires:
                - <Last Job>
